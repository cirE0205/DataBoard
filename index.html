<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å‘¨åº¦å·¥ä½œæˆæ•ˆæ•°æ®çœ‹æ¿</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    h1 { 
      color: #2c3e50; 
      margin-bottom: 10px; 
      font-size: 28px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      color: #7f8c8d;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .controls { 
      display: flex; 
      gap: 20px; 
      margin-bottom: 20px; 
      flex-wrap: wrap;
      align-items: center;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .control-group label {
      font-weight: 500;
      color: #495057;
    }
    #chart { 
      width: 100%; 
      height: 500px; 
      border: 1px solid #e9ecef; 
      border-radius: 8px;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: #6c757d;
      margin-bottom: 30px;
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 20px;
      font-size: 14px;
    }
    th, td { 
      border: 1px solid #dee2e6; 
      padding: 12px 8px; 
      text-align: center; 
    }
    th { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) { background: #f8f9fa; }
    tr:hover { background: #e9ecef; }
    input[type="text"], input[type="date"], input[type="number"], select { 
      padding: 8px 12px; 
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    button { 
      padding: 8px 16px; 
      margin: 0 4px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .btn-save { background: #28a745; color: white; }
    .btn-save:hover { background: #218838; }
    .btn-reset { background: #6c757d; color: white; }
    .btn-reset:hover { background: #5a6268; }
    .btn-edit { background: #ffc107; color: #212529; }
    .btn-edit:hover { background: #e0a800; }
    .btn-delete { background: #dc3545; color: white; }
    .btn-delete:hover { background: #c82333; }
    .btn-export { background: #17a2b8; color: white; }
    .btn-export:hover { background: #138496; }
    .admin { 
      background: linear-gradient(135deg, #fff6e6 0%, #ffe8cc 100%);
      padding: 20px; 
      border: 2px solid #f0a000; 
      border-radius: 8px;
      margin: 20px 0;
    }
    .admin h2 {
      color: #856404;
      margin-bottom: 15px;
      font-size: 20px;
    }
    .notice { 
      background: #fff3cd; 
      color: #856404; 
      border: 1px solid #ffeaa7; 
      padding: 12px; 
      margin-bottom: 15px; 
      display: none;
      border-radius: 4px;
      border-left: 4px solid #ffc107;
    }
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    @media (max-width: 768px) {
      .container { padding: 15px; }
      h1 { font-size: 22px; }
      #chart { height: 300px; }
      table { font-size: 12px; }
      th, td { padding: 8px 4px; }
      .controls { flex-direction: column; align-items: stretch; }
      .control-group { width: 100%; }
      button { width: 100%; margin: 4px 0; }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ“Š å‘¨åº¦å·¥ä½œæˆæ•ˆæ•°æ®çœ‹æ¿</h1>
  <div class="subtitle">Weekly Business Performance Dashboard</div>

  <div id="echartsNotice" class="notice">
    âš ï¸ å½“å‰ç¯å¢ƒæ— æ³•åŠ è½½ EChartsï¼ˆå¯èƒ½æ˜¯ CDN è¢«æ‹¦æˆªæˆ–æ— ç½‘ç»œï¼‰ã€‚å·²å¯ç”¨"æ— å›¾æ¨¡å¼"ï¼šä½ ä»å¯æ–°å¢/ç¼–è¾‘æ•°æ®å¹¶æŸ¥çœ‹è¡¨æ ¼ã€‚
  </div>

  <div class="controls">
    <div class="control-group">
      <label><input type="checkbox" id="adminToggle" onchange="toggleAdmin()"> ç®¡ç†å‘˜æ¨¡å¼</label>
    </div>
    
    <div class="control-group">
      <label>æ—¶é—´åŒºé—´ï¼š</label>
      <select id="rangeSelect" onchange="applyRange()">
        <option value="all">å…¨éƒ¨æ•°æ®</option>
        <option value="4">æœ€è¿‘ 4 å‘¨</option>
        <option value="8">æœ€è¿‘ 8 å‘¨</option>
        <option value="12">æœ€è¿‘ 12 å‘¨</option>
        <option value="custom">è‡ªå®šä¹‰</option>
      </select>
    </div>

    <div class="control-group" style="display:none;" id="customRange">
      <input type="date" id="startDate" onchange="applyRange()">
      <span>è‡³</span>
      <input type="date" id="endDate" onchange="applyRange()">
    </div>

    <div class="control-group">
      <button class="btn-export" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
      <button class="btn-export" onclick="document.getElementById('csvFileInput').click()">ğŸ“¤ å¯¼å…¥CSV</button>
      <input type="file" id="csvFileInput" accept=".csv" style="display:none;" onchange="importCSV(event)">
    </div>
  </div>

  <div id="chart">æ­£åœ¨åˆå§‹åŒ–å›¾è¡¨...</div>

  <div id="adminPanel" class="admin" style="display:none;">
    <h2>ğŸ“ æ•°æ®å½•å…¥ / ç¼–è¾‘</h2>
    <table>
      <tr>
        <th>æ—¥æœŸ/å‘¨æ¬¡</th>
        <th>æ³¨å†Œé‡</th>
        <th>ç”³è¯·å¼€æˆ·æ•°</th>
        <th>å¼€æˆ·æˆåŠŸæ•°</th>
        <th>å¼€æˆ·è½¬åŒ–ç‡(%)</th>
        <th>å¼€æˆ·æˆåŠŸç‡(%)</th>
        <th>å¹³å°å¹³å‡ç‡(%)</th>
        <th>æ“ä½œ</th>
      </tr>
      <tr>
        <td><input type="text" id="date" placeholder="2026-01-01 æˆ– ç¬¬1å‘¨" style="width:120px;"></td>
        <td><input type="number" id="registrations" min="0" style="width:80px;" oninput="autoCalculateRates()"></td>
        <td><input type="number" id="applications" min="0" style="width:80px;" oninput="autoCalculateRates()"></td>
        <td><input type="number" id="successes" min="0" style="width:80px;" oninput="autoCalculateRates()"></td>
        <td><input type="number" id="conversion_rate" min="0" max="100" step="0.1" style="width:70px;"></td>
        <td><input type="number" id="success_rate" min="0" max="100" step="0.1" style="width:70px;"></td>
        <td><input type="number" id="platform_avg" min="0" max="100" step="0.1" style="width:70px;"></td>
        <td>
          <button class="btn-save" onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
          <button class="btn-reset" onclick="resetForm()">ğŸ”„ æ¸…ç©º</button>
        </td>
      </tr>
    </table>
    <div style="margin-top:10px; color:#856404; font-size:12px;">
      ğŸ’¡ æç¤º: è¾“å…¥æ³¨å†Œé‡ã€ç”³è¯·å¼€æˆ·æ•°ã€å¼€æˆ·æˆåŠŸæ•°åï¼Œè½¬åŒ–ç‡ä¼šè‡ªåŠ¨è®¡ç®—ï¼ˆä¹Ÿå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰
    </div>
  </div>

  <h2 style="margin-top:30px; color:#2c3e50;">ğŸ“‹ å·²å½•å…¥æ•°æ®</h2>
  <table id="dataTable"></table>
</div>

<script>
// ========== æ•°æ®ä¸çŠ¶æ€ ==========
let rawData = JSON.parse(localStorage.getItem('weeklyMetrics')) || [
  { date: '2026-01-01', registrations: 10, applications: 4, successes: 2, conversion_rate: 40, success_rate: 50, platform_avg: 65 },
  { date: '2026-01-02', registrations: 18, applications: 6, successes: 3, conversion_rate: 33, success_rate: 50, platform_avg: 65 },
  { date: '2026-01-04', registrations: 50, applications: 24, successes: 15, conversion_rate: 48, success_rate: 63, platform_avg: 58 },
  { date: '2026-01-05', registrations: 65, applications: 42, successes: 32, conversion_rate: 65, success_rate: 76, platform_avg: 58 },
  { date: '2026-01-07', registrations: 68, applications: 40, successes: 42, conversion_rate: 59, success_rate: 105, platform_avg: 59 },
  { date: '2026-01-08', registrations: 70, applications: 36, successes: 35, conversion_rate: 51, success_rate: 97, platform_avg: 58 },
  { date: '2026-01-09', registrations: 63, applications: 28, successes: 26, conversion_rate: 44, success_rate: 93, platform_avg: 78 },
  { date: '2026-01-10', registrations: 50, applications: 34, successes: 30, conversion_rate: 68, success_rate: 88, platform_avg: 54 },
  { date: '2026-01-11', registrations: 80, applications: 29, successes: 14, conversion_rate: 36, success_rate: 48, platform_avg: 54 },
  { date: '2026-01-12', registrations: 120, applications: 76, successes: 66, conversion_rate: 63, success_rate: 87, platform_avg: 52 },
  { date: '2026-01-13', registrations: 75, applications: 43, successes: 36, conversion_rate: 57, success_rate: 84, platform_avg: 53 },
  { date: '2026-01-14', registrations: 70, applications: 53, successes: 50, conversion_rate: 76, success_rate: 94, platform_avg: 52 },
  { date: '2026-01-15', registrations: 70, applications: 42, successes: 38, conversion_rate: 60, success_rate: 90, platform_avg: 52 },
  { date: '2026-01-16', registrations: 52, applications: 23, successes: 20, conversion_rate: 44, success_rate: 87, platform_avg: 51 },
  { date: '2026-01-17', registrations: 38, applications: 19, successes: 23, conversion_rate: 50, success_rate: 121, platform_avg: 51 },
  { date: '2026-01-18', registrations: 28, applications: 13, successes: 10, conversion_rate: 46, success_rate: 77, platform_avg: 51 },
  { date: '2026-01-20', registrations: 60, applications: 17, successes: 41, conversion_rate: 28, success_rate: 241, platform_avg: 68 },
  { date: '2026-01-21', registrations: 10, applications: 7, successes: 7, conversion_rate: 70, success_rate: 100, platform_avg: 68 }
];

let editingIndex = null;
let isAdmin = false;
let filteredData = [...rawData];
let chart = null;

// ========== ECharts å®‰å…¨åˆå§‹åŒ– ==========
function initChartSafely() {
  const chartEl = document.getElementById('chart');
  if (window.echarts && typeof window.echarts.init === 'function') {
    chart = window.echarts.init(chartEl);
    renderChart();
    window.addEventListener('resize', () => chart && chart.resize());
  } else {
    document.getElementById('echartsNotice').style.display = 'block';
    chartEl.innerHTML = 'âŒ å›¾è¡¨ä¸å¯ç”¨ï¼ˆECharts æœªåŠ è½½ï¼‰';
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initChartSafely);
} else {
  initChartSafely();
}

// ========== ä¸šåŠ¡é€»è¾‘ ==========
function toggleAdmin() {
  isAdmin = document.getElementById('adminToggle').checked;
  document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
}

function autoCalculateRates() {
  const reg = parseFloat(document.getElementById('registrations').value) || 0;
  const app = parseFloat(document.getElementById('applications').value) || 0;
  const succ = parseFloat(document.getElementById('successes').value) || 0;
  
  if (reg > 0) {
    const convRate = ((app / reg) * 100).toFixed(1);
    document.getElementById('conversion_rate').value = convRate;
  }
  
  if (app > 0) {
    const succRate = ((succ / app) * 100).toFixed(1);
    document.getElementById('success_rate').value = succRate;
  }
}

function renderChart() {
  if (!chart || filteredData.length === 0) return;

  const dates = filteredData.map(d => d.date);

  const option = {
    title: {
      text: 'å‘¨åº¦å·¥ä½œæˆæ•ˆæ ¸å¿ƒæŒ‡æ ‡è¶‹åŠ¿å›¾',
      left: 'center',
      textStyle: { fontSize: 18, fontWeight: 'bold', color: '#2c3e50' }
    },
    tooltip: { 
      trigger: 'axis',
      axisPointer: { type: 'cross', crossStyle: { color: '#999' } }
    },
    legend: { 
      data: ['æ³¨å†Œé‡', 'ç”³è¯·å¼€æˆ·æ•°', 'å¼€æˆ·æˆåŠŸæ•°', 'å¼€æˆ·è½¬åŒ–ç‡', 'å¼€æˆ·æˆåŠŸç‡', 'å¹³å°å¹³å‡è½¬åŒ–ç‡'],
      top: 35,
      textStyle: { fontSize: 12 }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: { 
      type: 'category', 
      data: dates,
      axisPointer: { type: 'shadow' },
      axisLabel: { rotate: 45, fontSize: 11 }
    },
    yAxis: [
      { 
        type: 'value', 
        name: 'æ•°é‡(ä¸ª)', 
        position: 'left',
        axisLabel: { formatter: '{value}' },
        splitLine: { lineStyle: { type: 'dashed', opacity: 0.3 } }
      },
      { 
        type: 'value', 
        name: 'æ¯”ä¾‹(%)', 
        position: 'right',
        min: 0,
        max: 120,
        axisLabel: { formatter: '{value}%' },
        splitLine: { show: false }
      }
    ],
    series: [
      { 
        name: 'æ³¨å†Œé‡', 
        type: 'bar', 
        yAxisIndex: 0, 
        data: filteredData.map(d => d.registrations),
        itemStyle: { color: '#5B8FF9' },
        barMaxWidth: 40
      },
      { 
        name: 'ç”³è¯·å¼€æˆ·æ•°', 
        type: 'bar', 
        yAxisIndex: 0, 
        data: filteredData.map(d => d.applications),
        itemStyle: { color: '#5AD8A6' },
        barMaxWidth: 40
      },
      { 
        name: 'å¼€æˆ·æˆåŠŸæ•°', 
        type: 'bar', 
        yAxisIndex: 0, 
        data: filteredData.map(d => d.successes),
        itemStyle: { color: '#FF6B6B' },
        barMaxWidth: 40
      },
      { 
        name: 'å¼€æˆ·è½¬åŒ–ç‡', 
        type: 'line', 
        yAxisIndex: 1, 
        data: filteredData.map(d => d.conversion_rate),
        itemStyle: { color: '#FFD700' },
        lineStyle: { width: 3 },
        symbol: 'circle',
        symbolSize: 8
      },
      { 
        name: 'å¼€æˆ·æˆåŠŸç‡', 
        type: 'line', 
        yAxisIndex: 1, 
        data: filteredData.map(d => d.success_rate),
        itemStyle: { color: '#FFA940' },
        lineStyle: { width: 3 },
        symbol: 'diamond',
        symbolSize: 8
      },
      { 
        name: 'å¹³å°å¹³å‡è½¬åŒ–ç‡', 
        type: 'line', 
        yAxisIndex: 1, 
        data: filteredData.map(d => d.platform_avg),
        itemStyle: { color: '#1890FF' },
        lineStyle: { width: 3 },
        symbol: 'circle',
        symbolSize: 8
      }
    ]
  };

  chart.setOption(option);
}

function renderTable() {
  const table = document.getElementById('dataTable');
  table.innerHTML = `
    <tr>
      <th>æ—¥æœŸ/å‘¨æ¬¡</th><th>æ³¨å†Œé‡</th><th>ç”³è¯·å¼€æˆ·æ•°</th><th>å¼€æˆ·æˆåŠŸæ•°</th>
      <th>å¼€æˆ·è½¬åŒ–ç‡</th><th>å¼€æˆ·æˆåŠŸç‡</th><th>å¹³å°å¹³å‡ç‡</th><th>æ“ä½œ</th>
    </tr>`;

  rawData.forEach((d, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="font-weight:500;">${d.date}</td>
      <td>${d.registrations}</td>
      <td>${d.applications}</td>
      <td>${d.successes}</td>
      <td>${d.conversion_rate}%</td>
      <td>${d.success_rate}%</td>
      <td>${d.platform_avg}%</td>
      <td>
        <button class="btn-edit" onclick="editData(${i})">âœï¸ ç¼–è¾‘</button>
        <button class="btn-delete" onclick="deleteData(${i})">ğŸ—‘ï¸ åˆ é™¤</button>
      </td>`;
    table.appendChild(row);
  });
}

function saveData() {
  if (!isAdmin) return alert('âŒ è¯·å…ˆå¼€å¯ç®¡ç†å‘˜æ¨¡å¼');

  const date = document.getElementById('date').value.trim();
  const registrations = parseFloat(document.getElementById('registrations').value) || 0;
  const applications = parseFloat(document.getElementById('applications').value) || 0;
  const successes = parseFloat(document.getElementById('successes').value) || 0;
  const conversion_rate = parseFloat(document.getElementById('conversion_rate').value) || 0;
  const success_rate = parseFloat(document.getElementById('success_rate').value) || 0;
  const platform_avg = parseFloat(document.getElementById('platform_avg').value) || 0;

  if (!date) return alert('âŒ æ—¥æœŸä¸èƒ½ä¸ºç©º');

  if (editingIndex === null && rawData.find(d => d.date === date)) {
    return alert('âŒ è¯¥æ—¥æœŸå·²å­˜åœ¨æ•°æ®ï¼Œè¯·ä½¿ç”¨ç¼–è¾‘åŠŸèƒ½');
  }

  const record = { date, registrations, applications, successes, conversion_rate, success_rate, platform_avg };

  if (editingIndex !== null) {
    rawData[editingIndex] = record;
    editingIndex = null;
  } else {
    rawData.push(record);
  }

  rawData.sort((a, b) => a.date.localeCompare(b.date));
  localStorage.setItem('weeklyMetrics', JSON.stringify(rawData));
  applyRange();
  resetForm();
  alert('âœ… æ•°æ®å·²ä¿å­˜');
}

function editData(i) {
  if (!isAdmin) return alert('âŒ è¯·å…ˆå¼€å¯ç®¡ç†å‘˜æ¨¡å¼');
  const d = rawData[i];
  editingIndex = i;
  document.getElementById('date').value = d.date;
  document.getElementById('registrations').value = d.registrations;
  document.getElementById('applications').value = d.applications;
  document.getElementById('successes').value = d.successes;
  document.getElementById('conversion_rate').value = d.conversion_rate;
  document.getElementById('success_rate').value = d.success_rate;
  document.getElementById('platform_avg').value = d.platform_avg;
  
  // æ»šåŠ¨åˆ°è¡¨å•
  document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
}

function deleteData(i) {
  if (!isAdmin) return alert('âŒ è¯·å…ˆå¼€å¯ç®¡ç†å‘˜æ¨¡å¼');
  if (!confirm('âš ï¸ ç¡®è®¤åˆ é™¤è¯¥æ¡æ•°æ®ï¼Ÿ')) return;
  rawData.splice(i, 1);
  localStorage.setItem('weeklyMetrics', JSON.stringify(rawData));
  applyRange();
  alert('âœ… æ•°æ®å·²åˆ é™¤');
}

function resetForm() {
  document.getElementById('date').value = '';
  document.getElementById('registrations').value = '';
  document.getElementById('applications').value = '';
  document.getElementById('successes').value = '';
  document.getElementById('conversion_rate').value = '';
  document.getElementById('success_rate').value = '';
  document.getElementById('platform_avg').value = '';
  editingIndex = null;
}

function applyRange() {
  const range = document.getElementById('rangeSelect').value;
  const customRange = document.getElementById('customRange');
  let data = [...rawData];

  if (range === 'custom') {
    customRange.style.display = 'flex';
    const s = document.getElementById('startDate').value;
    const e = document.getElementById('endDate').value;
    if (s && e) data = data.filter(d => d.date >= s && d.date <= e);
  } else {
    customRange.style.display = 'none';
    if (range !== 'all') {
      data = data.slice(-Number(range));
    }
  }

  filteredData = data;
  renderChart();
  renderTable();
}

function exportData() {
  const csv = [
    ['æ—¥æœŸ/å‘¨æ¬¡', 'æ³¨å†Œé‡', 'ç”³è¯·å¼€æˆ·æ•°', 'å¼€æˆ·æˆåŠŸæ•°', 'å¼€æˆ·è½¬åŒ–ç‡(%)', 'å¼€æˆ·æˆåŠŸç‡(%)', 'å¹³å°å¹³å‡ç‡(%)'],
    ...rawData.map(d => [d.date, d.registrations, d.applications, d.successes, d.conversion_rate, d.success_rate, d.platform_avg])
  ].map(row => row.join(',')).join('\n');
  
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `å‘¨åº¦æ•°æ®_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
}

function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const content = e.target.result;
      const lines = content.split('\n').filter(line => line.trim());
      
      // è·³è¿‡è¡¨å¤´
      const dataLines = lines.slice(1);
      
      if (dataLines.length === 0) {
        alert('âŒ CSVæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
        return;
      }

      const importedData = [];
      const errors = [];

      dataLines.forEach((line, idx) => {
        const parts = line.split(',').map(p => p.trim());
        
        if (parts.length < 7) {
          errors.push(`ç¬¬${idx + 2}è¡Œ: åˆ—æ•°ä¸è¶³ï¼ˆéœ€è¦7åˆ—ï¼‰`);
          return;
        }

        const [date, reg, app, succ, conv, succRate, platAvg] = parts;
        
        // éªŒè¯æ•°æ®
        if (!date) {
          errors.push(`ç¬¬${idx + 2}è¡Œ: æ—¥æœŸä¸ºç©º`);
          return;
        }

        const record = {
          date: date,
          registrations: parseFloat(reg) || 0,
          applications: parseFloat(app) || 0,
          successes: parseFloat(succ) || 0,
          conversion_rate: parseFloat(conv) || 0,
          success_rate: parseFloat(succRate) || 0,
          platform_avg: parseFloat(platAvg) || 0
        };

        importedData.push(record);
      });

      if (errors.length > 0) {
        const showErrors = errors.slice(0, 5).join('\n');
        const more = errors.length > 5 ? `\n...è¿˜æœ‰${errors.length - 5}ä¸ªé”™è¯¯` : '';
        if (!confirm(`âš ï¸ å‘ç°${errors.length}ä¸ªé”™è¯¯:\n${showErrors}${more}\n\næ˜¯å¦ç»§ç»­å¯¼å…¥æœ‰æ•ˆæ•°æ®ï¼Ÿ`)) {
          return;
        }
      }

      if (importedData.length === 0) {
        alert('âŒ æ²¡æœ‰æœ‰æ•ˆæ•°æ®å¯å¯¼å…¥');
        return;
      }

      // è¯¢é—®æ˜¯å¦æ›¿æ¢æˆ–åˆå¹¶
      const action = confirm(
        `ğŸ“Š æˆåŠŸè§£æ${importedData.length}æ¡æ•°æ®\n\nç‚¹å‡»"ç¡®å®š"æ›¿æ¢ç°æœ‰æ•°æ®\nç‚¹å‡»"å–æ¶ˆ"åˆå¹¶åˆ°ç°æœ‰æ•°æ®`
      );

      if (action) {
        // æ›¿æ¢æ¨¡å¼
        rawData = importedData;
      } else {
        // åˆå¹¶æ¨¡å¼ï¼šå»é‡ï¼ˆåŒæ—¥æœŸåˆ™æ›´æ–°ï¼‰
        importedData.forEach(newRecord => {
          const existingIdx = rawData.findIndex(d => d.date === newRecord.date);
          if (existingIdx >= 0) {
            rawData[existingIdx] = newRecord;
          } else {
            rawData.push(newRecord);
          }
        });
      }

      rawData.sort((a, b) => a.date.localeCompare(b.date));
      localStorage.setItem('weeklyMetrics', JSON.stringify(rawData));
      applyRange();
      
      alert(`âœ… æˆåŠŸå¯¼å…¥${importedData.length}æ¡æ•°æ®ï¼`);
    } catch (error) {
      alert('âŒ CSVè§£æå¤±è´¥: ' + error.message);
    }
  };

  reader.onerror = function() {
    alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥');
  };

  reader.readAsText(file, 'UTF-8');
  
  // é‡ç½®inputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
  event.target.value = '';
}

// åˆå§‹æ¸²æŸ“
applyRange();
</script>

</body>
</html>
