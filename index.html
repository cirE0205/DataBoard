<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å‘¨åº¦å·¥ä½œæˆæ•ˆæ•°æ®çœ‹æ¿</title>
  <script src="./echarts.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    h1 { 
      color: #2c3e50; 
      margin-bottom: 10px; 
      font-size: 28px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      color: #7f8c8d;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .controls { 
      display: flex; 
      gap: 20px; 
      margin-bottom: 20px; 
      flex-wrap: wrap;
      align-items: center;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .control-group label {
      font-weight: 500;
      color: #495057;
    }
    #chart { 
      width: 100%; 
      height: 500px; 
      border: 1px solid #e9ecef; 
      border-radius: 8px;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: #6c757d;
      margin-bottom: 30px;
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 20px;
      font-size: 14px;
    }
    th, td { 
      border: 1px solid #dee2e6; 
      padding: 12px 8px; 
      text-align: center; 
    }
    th { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) { background: #f8f9fa; }
    tr:hover { background: #e9ecef; }
    input[type="text"], input[type="date"], input[type="number"], select { 
      padding: 8px 12px; 
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    button { 
      padding: 8px 16px; 
      margin: 0 4px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .btn-save { background: #28a745; color: white; }
    .btn-save:hover { background: #218838; }
    .btn-reset { background: #6c757d; color: white; }
    .btn-reset:hover { background: #5a6268; }
    .btn-edit { background: #ffc107; color: #212529; }
    .btn-edit:hover { background: #e0a800; }
    .btn-delete { background: #dc3545; color: white; }
    .btn-delete:hover { background: #c82333; }
    .btn-export { background: #17a2b8; color: white; }
    .btn-export:hover { background: #138496; }
    .admin { 
      background: linear-gradient(135deg, #fff6e6 0%, #ffe8cc 100%);
      padding: 20px; 
      border: 2px solid #f0a000; 
      border-radius: 8px;
      margin: 20px 0;
    }
    .admin h2 {
      color: #856404;
      margin-bottom: 15px;
      font-size: 20px;
    }
    .notice { 
      background: #fff3cd; 
      color: #856404; 
      border: 1px solid #ffeaa7; 
      padding: 12px; 
      margin-bottom: 15px; 
      display: none;
      border-radius: 4px;
      border-left: 4px solid #ffc107;
    }
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    @media (max-width: 768px) {
      .container { padding: 15px; }
      h1 { font-size: 22px; }
      #chart { height: 300px; }
      table { font-size: 12px; }
      th, td { padding: 8px 4px; }
      .controls { flex-direction: column; align-items: stretch; }
      .control-group { width: 100%; }
      button { width: 100%; margin: 4px 0; }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ“Š å‘¨åº¦å·¥ä½œæˆæ•ˆæ•°æ®çœ‹æ¿</h1>
  <div class="subtitle">Weekly Business Performance Dashboard</div>

  <div id="echartsNotice" class="notice">
    âš ï¸ å›¾è¡¨åŠ è½½å¤±è´¥ã€‚å·²å¯ç”¨"æ— å›¾æ¨¡å¼"ï¼šä½ ä»å¯æ–°å¢/ç¼–è¾‘æ•°æ®å¹¶æŸ¥çœ‹è¡¨æ ¼ã€‚
  </div>

  <div class="controls">
    <div class="control-group">
      <label><input type="checkbox" id="adminToggle" onchange="toggleAdmin()"> ç®¡ç†å‘˜æ¨¡å¼</label>
    </div>
    
    <div class="control-group">
      <label>æ—¶é—´åŒºé—´ï¼š</label>
      <select id="rangeSelect" onchange="applyRange()">
        <option value="all">å…¨éƒ¨æ•°æ®</option>
        <option value="4">æœ€è¿‘ 4 å‘¨</option>
        <option value="8">æœ€è¿‘ 8 å‘¨</option>
        <option value="12">æœ€è¿‘ 12 å‘¨</option>
        <option value="custom">è‡ªå®šä¹‰</option>
      </select>
    </div>

    <div class="control-group" style="display:none;" id="customRange">
      <input type="date" id="startDate" onchange="applyRange()">
      <span>è‡³</span>
      <input type="date" id="endDate" onchange="applyRange()">
    </div>

    <div class="control-group">
      <button class="btn-export" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
      <button class="btn-export" onclick="document.getElementById('csvFileInput').click()">ğŸ“¤ å¯¼å…¥CSV</button>
      <input type="file" id="csvFileInput" accept=".csv" style="display:none;" onchange="importCSV(event)">
    </div>
  </div>

  <div id="chart">æ­£åœ¨åˆå§‹åŒ–å›¾è¡¨...</div>

  <div id="adminPanel" class="admin" style="display:none;">
    <h2>ğŸ“ æ•°æ®å½•å…¥ / ç¼–è¾‘</h2>
    <table>
      <tr>
        <th>æ—¥æœŸ/å‘¨æ¬¡</th>
        <th>æ³¨å†Œé‡</th>
        <th>å¼€æˆ·æˆåŠŸæ•°</th>
        <th>å¼€æˆ·è½¬åŒ–ç‡(%)</th>
        <th>å…¥é‡‘æ•°</th>
        <th>å…¥é‡‘ç‡(%)</th>
        <th>å…¥é‡‘èµ„äº§</th>
        <th>æœ‰æ•ˆæˆ·æ•°</th>
        <th>æœ‰æ•ˆæˆ·ç‡(%)</th>
        <th>åˆ›æ”¶</th>
        <th>æ“ä½œ</th>
      </tr>
      <tr>
        <td><input type="text" id="date" placeholder="12æœˆ2æ—¥-12æœˆ8æ—¥" style="width:140px;"></td>
        <td><input type="number" id="registrations" min="0" style="width:80px;" oninput="autoCalculateRates()"></td>
        <td><input type="number" id="successes" min="0" style="width:80px;" oninput="autoCalculateRates()"></td>
        <td><input type="number" id="conversion_rate" min="0" max="100" step="0.01" style="width:70px;"></td>
        <td><input type="number" id="deposits" min="0" style="width:80px;" oninput="autoCalculateRates()"></td>
        <td><input type="number" id="deposit_rate" min="0" max="100" step="0.01" style="width:70px;"></td>
        <td><input type="number" id="deposit_assets" min="0" style="width:90px;"></td>
        <td><input type="number" id="active_users" min="0" style="width:80px;" oninput="autoCalculateRates()"></td>
        <td><input type="number" id="active_rate" min="0" max="100" step="0.01" style="width:70px;"></td>
        <td><input type="number" id="revenue" min="0" style="width:90px;"></td>
        <td>
          <button class="btn-save" onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
          <button class="btn-reset" onclick="resetForm()">ğŸ”„ æ¸…ç©º</button>
        </td>
      </tr>
    </table>
    <div style="margin-top:10px; color:#856404; font-size:12px;">
      ğŸ’¡ æç¤º: è¾“å…¥æ³¨å†Œé‡ã€å¼€æˆ·æˆåŠŸæ•°åï¼Œå¼€æˆ·è½¬åŒ–ç‡ä¼šè‡ªåŠ¨è®¡ç®—ï¼ˆä¿ç•™2ä½å°æ•°ï¼‰<br>
      ğŸ’¡ æç¤º: å…¥é‡‘ç‡ = å…¥é‡‘æ•°Ã·å¼€æˆ·æˆåŠŸæ•° Ã— 100%ï¼Œæœ‰æ•ˆæˆ·ç‡ = æœ‰æ•ˆæˆ·æ•°Ã·å¼€æˆ·æˆåŠŸæ•° Ã— 100%
    </div>
  </div>

  <h2 style="margin-top:30px; color:#2c3e50;">ğŸ“‹ å·²å½•å…¥æ•°æ®</h2>
  <table id="dataTable"></table>
</div>

<script>
// ========== æ•°æ®è¿ç§»å’Œä¿®å¤ ==========
function migrateAndFixData() {
  let data = JSON.parse(localStorage.getItem('weeklyMetrics')) || [];
  
  // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤ç¤ºä¾‹æ•°æ®
  if (data.length === 0) {
    return [
      { date: '12æœˆ2æ—¥-12æœˆ8æ—¥', registrations: 1152, successes: 500, conversion_rate: 43.4, deposits: 300, deposit_rate: 60.0, deposit_assets: 0, active_users: 250, active_rate: 50.0, revenue: 15000 },
      { date: '12æœˆ9æ—¥-12æœˆ15æ—¥', registrations: 1082, successes: 480, conversion_rate: 44.4, deposits: 280, deposit_rate: 58.3, deposit_assets: 0, active_users: 240, active_rate: 50.0, revenue: 14500 },
      { date: '12æœˆ16æ—¥-12æœˆ22æ—¥', registrations: 1341, successes: 600, conversion_rate: 44.7, deposits: 350, deposit_rate: 58.3, deposit_assets: 0, active_users: 300, active_rate: 50.0, revenue: 18000 },
      { date: '12æœˆ23æ—¥-12æœˆ29æ—¥', registrations: 2208, successes: 950, conversion_rate: 43.0, deposits: 550, deposit_rate: 57.9, deposit_assets: 0, active_users: 480, active_rate: 50.5, revenue: 28000 },
      { date: '12æœˆ30æ—¥-1æœˆ5æ—¥', registrations: 1675, successes: 720, conversion_rate: 43.0, deposits: 420, deposit_rate: 58.3, deposit_assets: 0, active_users: 360, active_rate: 50.0, revenue: 21000 },
      { date: '1æœˆ6æ—¥-1æœˆ12æ—¥', registrations: 3614, successes: 1550, conversion_rate: 42.9, deposits: 900, deposit_rate: 58.1, deposit_assets: 0, active_users: 780, active_rate: 50.3, revenue: 46500 },
      { date: '1æœˆ13æ—¥-1æœˆ19æ—¥', registrations: 3063, successes: 1320, conversion_rate: 43.1, deposits: 770, deposit_rate: 58.3, deposit_assets: 0, active_users: 660, active_rate: 50.0, revenue: 39600 }
    ];
  }
  
  // ä¿®å¤ç°æœ‰æ•°æ®ï¼šé‡æ–°è®¡ç®—æ‰€æœ‰ç™¾åˆ†æ¯”ï¼ˆé˜²æ­¢0%æˆ–é”™è¯¯å€¼ï¼‰
  let fixed = false;
  data = data.map(record => {
    const reg = parseFloat(record.registrations) || 0;
    const succ = parseFloat(record.successes) || 0;
    const dep = parseFloat(record.deposits) || 0;
    const active = parseFloat(record.active_users) || 0;
    
    // é‡æ–°è®¡ç®—è½¬åŒ–ç‡ (ä¿ç•™2ä½å°æ•°)
    const newConvRate = reg > 0 ? parseFloat(((succ / reg) * 100).toFixed(2)) : 0;
    const newDepRate = succ > 0 ? parseFloat(((dep / succ) * 100).toFixed(2)) : 0;
    const newActiveRate = succ > 0 ? parseFloat(((active / succ) * 100).toFixed(2)) : 0;
    
    // å¦‚æœå‘ç°æ•°æ®ä¸å¯¹ï¼Œæ ‡è®°éœ€è¦ä¿®å¤
    if (record.conversion_rate === 0 || record.deposit_rate === 0 || record.active_rate === 0) {
      fixed = true;
    }
    
    return {
      date: record.date,
      registrations: reg,
      successes: succ,
      conversion_rate: newConvRate,
      deposits: dep,
      deposit_rate: newDepRate,
      deposit_assets: parseFloat(record.deposit_assets) || 0,
      active_users: active,
      active_rate: newActiveRate,
      revenue: parseFloat(record.revenue) || 0
    };
  });
  
  // å¦‚æœä¿®å¤äº†æ•°æ®ï¼Œä¿å­˜å› localStorage
  if (fixed) {
    localStorage.setItem('weeklyMetrics', JSON.stringify(data));
    console.log('âœ… æ•°æ®å·²è‡ªåŠ¨ä¿®å¤ï¼šé‡æ–°è®¡ç®—äº†æ‰€æœ‰è½¬åŒ–ç‡');
  }
  
  // ä¿æŒåŸå§‹é¡ºåºï¼ˆä¸æ’åºï¼‰
  return data;
}

// ========== æ•°æ®ä¸çŠ¶æ€ ==========
let rawData = migrateAndFixData();

let editingIndex = null;
let isAdmin = false;
let filteredData = [...rawData];
let chart = null;

// ========== ECharts å®‰å…¨åˆå§‹åŒ– ==========
function initChartSafely() {
  const chartEl = document.getElementById('chart');
  if (window.echarts && typeof window.echarts.init === 'function') {
    chart = window.echarts.init(chartEl);
    renderChart();
    window.addEventListener('resize', () => chart && chart.resize());
  } else {
    document.getElementById('echartsNotice').style.display = 'block';
    chartEl.innerHTML = 'âŒ å›¾è¡¨ä¸å¯ç”¨ï¼ˆECharts æœªåŠ è½½ï¼‰';
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initChartSafely);
} else {
  initChartSafely();
}

// ========== ä¸šåŠ¡é€»è¾‘ ==========
function toggleAdmin() {
  isAdmin = document.getElementById('adminToggle').checked;
  document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
}

function autoCalculateRates() {
  const reg = parseFloat(document.getElementById('registrations').value) || 0;
  const succ = parseFloat(document.getElementById('successes').value) || 0;
  const dep = parseFloat(document.getElementById('deposits').value) || 0;
  const active = parseFloat(document.getElementById('active_users').value) || 0;
  
  // å¼€æˆ·è½¬åŒ–ç‡ = å¼€æˆ·æˆåŠŸæ•° Ã· æ³¨å†Œé‡ (ä¿ç•™2ä½å°æ•°)
  if (reg > 0 && succ > 0) {
    const convRate = ((succ / reg) * 100).toFixed(2);
    document.getElementById('conversion_rate').value = convRate;
  }
  
  // å…¥é‡‘ç‡ = å…¥é‡‘æ•° Ã· å¼€æˆ·æˆåŠŸæ•° (ä¿ç•™2ä½å°æ•°)
  if (succ > 0 && dep > 0) {
    const depRate = ((dep / succ) * 100).toFixed(2);
    document.getElementById('deposit_rate').value = depRate;
  }
  
  // æœ‰æ•ˆæˆ·ç‡ = æœ‰æ•ˆæˆ·æ•° Ã· å¼€æˆ·æˆåŠŸæ•° (ä¿ç•™2ä½å°æ•°)
  if (succ > 0 && active > 0) {
    const activeRate = ((active / succ) * 100).toFixed(2);
    document.getElementById('active_rate').value = activeRate;
  }
}

function renderChart() {
  if (!chart || filteredData.length === 0) return;

  const dates = filteredData.map(d => d.date);

  const option = {
    title: {
      text: 'å‘¨åº¦å·¥ä½œæˆæ•ˆæ ¸å¿ƒæŒ‡æ ‡è¶‹åŠ¿å›¾',
      left: 'center',
      textStyle: { fontSize: 18, fontWeight: 'bold', color: '#2c3e50' }
    },
    tooltip: { 
      trigger: 'axis',
      axisPointer: { type: 'cross', crossStyle: { color: '#999' } }
    },
    legend: { 
      data: ['æ³¨å†Œé‡', 'å¼€æˆ·æˆåŠŸæ•°', 'å…¥é‡‘æ•°', 'å…¥é‡‘èµ„äº§', 'æœ‰æ•ˆæˆ·æ•°', 'åˆ›æ”¶', 'å¼€æˆ·è½¬åŒ–ç‡', 'å…¥é‡‘ç‡', 'æœ‰æ•ˆæˆ·ç‡'],
      top: 35,
      textStyle: { fontSize: 9 }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: { 
      type: 'category', 
      data: dates,
      axisPointer: { type: 'shadow' },
      axisLabel: { rotate: 45, fontSize: 10 }
    },
    yAxis: [
      { 
        type: 'value', 
        name: 'æ•°é‡(ä¸ª) / åˆ›æ”¶ / å…¥é‡‘èµ„äº§', 
        position: 'left',
        axisLabel: { formatter: '{value}' },
        splitLine: { lineStyle: { type: 'dashed', opacity: 0.3 } }
      },
      { 
        type: 'value', 
        name: 'æ¯”ä¾‹(%)', 
        position: 'right',
        min: 0,
        max: 100,
        axisLabel: { formatter: '{value}%' },
        splitLine: { show: false }
      }
    ],
    series: [
      { 
        name: 'æ³¨å†Œé‡', 
        type: 'bar', 
        yAxisIndex: 0, 
        data: filteredData.map(d => d.registrations),
        itemStyle: { color: '#5B8FF9' },
        barMaxWidth: 30
      },
      { 
        name: 'å¼€æˆ·æˆåŠŸæ•°', 
        type: 'bar', 
        yAxisIndex: 0, 
        data: filteredData.map(d => d.successes),
        itemStyle: { color: '#5AD8A6' },
        barMaxWidth: 30
      },
      { 
        name: 'å…¥é‡‘æ•°', 
        type: 'bar', 
        yAxisIndex: 0, 
        data: filteredData.map(d => d.deposits),
        itemStyle: { color: '#FF9D4E' },
        barMaxWidth: 30
      },
      { 
        name: 'å…¥é‡‘èµ„äº§', 
        type: 'line', 
        yAxisIndex: 0, 
        data: filteredData.map(d => d.deposit_assets),
        itemStyle: { color: '#FF85C0' },
        lineStyle: { width: 3, type: 'solid' },
        symbol: 'diamond',
        symbolSize: 8
      },
      { 
        name: 'æœ‰æ•ˆæˆ·æ•°', 
        type: 'bar', 
        yAxisIndex: 0, 
        data: filteredData.map(d => d.active_users),
        itemStyle: { color: '#FF6B6B' },
        barMaxWidth: 30
      },
      { 
        name: 'åˆ›æ”¶', 
        type: 'line', 
        yAxisIndex: 0, 
        data: filteredData.map(d => d.revenue),
        itemStyle: { color: '#13C2C2' },
        lineStyle: { width: 3, type: 'dashed' },
        symbol: 'rect',
        symbolSize: 8
      },
      { 
        name: 'å¼€æˆ·è½¬åŒ–ç‡', 
        type: 'line', 
        yAxisIndex: 1, 
        data: filteredData.map(d => d.conversion_rate),
        itemStyle: { color: '#1890FF' },
        lineStyle: { width: 3 },
        symbol: 'circle',
        symbolSize: 8
      },
      { 
        name: 'å…¥é‡‘ç‡', 
        type: 'line', 
        yAxisIndex: 1, 
        data: filteredData.map(d => d.deposit_rate),
        itemStyle: { color: '#9254DE' },
        lineStyle: { width: 3 },
        symbol: 'diamond',
        symbolSize: 8
      },
      { 
        name: 'æœ‰æ•ˆæˆ·ç‡', 
        type: 'line', 
        yAxisIndex: 1, 
        data: filteredData.map(d => d.active_rate),
        itemStyle: { color: '#F759AB' },
        lineStyle: { width: 3 },
        symbol: 'triangle',
        symbolSize: 8
      }
    ]
  };

  chart.setOption(option);
}

function renderTable() {
  const table = document.getElementById('dataTable');
  table.innerHTML = `
    <tr>
      <th>æ—¥æœŸ/å‘¨æ¬¡</th><th>æ³¨å†Œé‡</th><th>å¼€æˆ·æˆåŠŸæ•°</th><th>å¼€æˆ·è½¬åŒ–ç‡</th>
      <th>å…¥é‡‘æ•°</th><th>å…¥é‡‘ç‡</th><th>å…¥é‡‘èµ„äº§</th><th>æœ‰æ•ˆæˆ·æ•°</th><th>æœ‰æ•ˆæˆ·ç‡</th><th>åˆ›æ”¶</th><th>æ“ä½œ</th>
    </tr>`;

  rawData.forEach((d, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="font-weight:500;">${d.date}</td>
      <td>${d.registrations}</td>
      <td>${d.successes}</td>
      <td>${d.conversion_rate}%</td>
      <td>${d.deposits}</td>
      <td>${d.deposit_rate}%</td>
      <td>${d.deposit_assets ? d.deposit_assets.toLocaleString() : 0}</td>
      <td>${d.active_users}</td>
      <td>${d.active_rate}%</td>
      <td>${d.revenue ? d.revenue.toLocaleString() : 0}</td>
      <td>
        <button class="btn-edit" onclick="editData(${i})">âœï¸ ç¼–è¾‘</button>
        <button class="btn-delete" onclick="deleteData(${i})">ğŸ—‘ï¸ åˆ é™¤</button>
      </td>`;
    table.appendChild(row);
  });
}

function saveData() {
  if (!isAdmin) return alert('âŒ è¯·å…ˆå¼€å¯ç®¡ç†å‘˜æ¨¡å¼');

  const date = document.getElementById('date').value.trim();
  const registrations = parseFloat(document.getElementById('registrations').value) || 0;
  const successes = parseFloat(document.getElementById('successes').value) || 0;
  const conversion_rate = parseFloat(document.getElementById('conversion_rate').value) || 0;
  const deposits = parseFloat(document.getElementById('deposits').value) || 0;
  const deposit_rate = parseFloat(document.getElementById('deposit_rate').value) || 0;
  const deposit_assets = parseFloat(document.getElementById('deposit_assets').value) || 0;
  const active_users = parseFloat(document.getElementById('active_users').value) || 0;
  const active_rate = parseFloat(document.getElementById('active_rate').value) || 0;
  const revenue = parseFloat(document.getElementById('revenue').value) || 0;

  if (!date) return alert('âŒ æ—¥æœŸä¸èƒ½ä¸ºç©º');

  if (editingIndex === null && rawData.find(d => d.date === date)) {
    return alert('âŒ è¯¥æ—¥æœŸå·²å­˜åœ¨æ•°æ®ï¼Œè¯·ä½¿ç”¨ç¼–è¾‘åŠŸèƒ½');
  }

  const record = { date, registrations, successes, conversion_rate, deposits, deposit_rate, deposit_assets, active_users, active_rate, revenue };

  if (editingIndex !== null) {
    rawData[editingIndex] = record;
    editingIndex = null;
  } else {
    rawData.push(record);
  }

  // ä¸æ’åºï¼Œä¿æŒç”¨æˆ·è¾“å…¥é¡ºåº
  localStorage.setItem('weeklyMetrics', JSON.stringify(rawData));
  applyRange();
  resetForm();
  alert('âœ… æ•°æ®å·²ä¿å­˜');
}

function editData(i) {
  if (!isAdmin) return alert('âŒ è¯·å…ˆå¼€å¯ç®¡ç†å‘˜æ¨¡å¼');
  const d = rawData[i];
  editingIndex = i;
  document.getElementById('date').value = d.date;
  document.getElementById('registrations').value = d.registrations;
  document.getElementById('successes').value = d.successes;
  document.getElementById('conversion_rate').value = d.conversion_rate;
  document.getElementById('deposits').value = d.deposits;
  document.getElementById('deposit_rate').value = d.deposit_rate;
  document.getElementById('deposit_assets').value = d.deposit_assets || 0;
  document.getElementById('active_users').value = d.active_users;
  document.getElementById('active_rate').value = d.active_rate;
  document.getElementById('revenue').value = d.revenue;
  
  // æ»šåŠ¨åˆ°è¡¨å•
  document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
}

function deleteData(i) {
  if (!isAdmin) return alert('âŒ è¯·å…ˆå¼€å¯ç®¡ç†å‘˜æ¨¡å¼');
  if (!confirm('âš ï¸ ç¡®è®¤åˆ é™¤è¯¥æ¡æ•°æ®ï¼Ÿ')) return;
  rawData.splice(i, 1);
  localStorage.setItem('weeklyMetrics', JSON.stringify(rawData));
  applyRange();
  alert('âœ… æ•°æ®å·²åˆ é™¤');
}

function resetForm() {
  document.getElementById('date').value = '';
  document.getElementById('registrations').value = '';
  document.getElementById('successes').value = '';
  document.getElementById('conversion_rate').value = '';
  document.getElementById('deposits').value = '';
  document.getElementById('deposit_rate').value = '';
  document.getElementById('deposit_assets').value = '';
  document.getElementById('active_users').value = '';
  document.getElementById('active_rate').value = '';
  document.getElementById('revenue').value = '';
  editingIndex = null;
}

function applyRange() {
  const range = document.getElementById('rangeSelect').value;
  const customRange = document.getElementById('customRange');
  let data = [...rawData];

  if (range === 'custom') {
    customRange.style.display = 'flex';
    const s = document.getElementById('startDate').value;
    const e = document.getElementById('endDate').value;
    if (s && e) data = data.filter(d => d.date >= s && d.date <= e);
  } else {
    customRange.style.display = 'none';
    if (range !== 'all') {
      data = data.slice(-Number(range));
    }
  }

  filteredData = data;
  renderChart();
  renderTable();
}

function exportData() {
  const csv = [
    ['æ—¥æœŸ/å‘¨æ¬¡', 'æ³¨å†Œé‡', 'å¼€æˆ·æˆåŠŸæ•°', 'å¼€æˆ·è½¬åŒ–ç‡(%)', 'å…¥é‡‘æ•°', 'å…¥é‡‘ç‡(%)', 'å…¥é‡‘èµ„äº§', 'æœ‰æ•ˆæˆ·æ•°', 'æœ‰æ•ˆæˆ·ç‡(%)', 'åˆ›æ”¶'],
    ...rawData.map(d => [d.date, d.registrations, d.successes, d.conversion_rate, d.deposits, d.deposit_rate, d.deposit_assets || 0, d.active_users, d.active_rate, d.revenue])
  ].map(row => row.join(',')).join('\n');
  
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `å‘¨åº¦æ•°æ®_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
}

function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const content = e.target.result;
      const lines = content.split('\n').filter(line => line.trim());
      
      // è·³è¿‡è¡¨å¤´
      const dataLines = lines.slice(1);
      
      if (dataLines.length === 0) {
        alert('âŒ CSVæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
        return;
      }

      const importedData = [];
      const errors = [];

      dataLines.forEach((line, idx) => {
        const parts = line.split(',').map(p => p.trim());
        
        if (parts.length < 10) {
          errors.push(`ç¬¬${idx + 2}è¡Œ: åˆ—æ•°ä¸è¶³ï¼ˆéœ€è¦10åˆ—ï¼‰`);
          return;
        }

        const [date, reg, succ, conv, dep, depRate, depAssets, active, activeRate, rev] = parts;
        
        // éªŒè¯æ•°æ®
        if (!date) {
          errors.push(`ç¬¬${idx + 2}è¡Œ: æ—¥æœŸä¸ºç©º`);
          return;
        }

        // è§£æåŸºç¡€æ•°æ®
        const regNum = parseFloat(reg) || 0;
        const succNum = parseFloat(succ) || 0;
        const depNum = parseFloat(dep) || 0;
        const activeNum = parseFloat(active) || 0;
        
        // æ™ºèƒ½è®¡ç®—ï¼šå¦‚æœCSVä¸­ç™¾åˆ†æ¯”ä¸ºç©ºæˆ–0ï¼Œåˆ™è‡ªåŠ¨è®¡ç®—
        let convRate = parseFloat(conv) || 0;
        let depRateNum = parseFloat(depRate) || 0;
        let activeRateNum = parseFloat(activeRate) || 0;
        
        // å¦‚æœç™¾åˆ†æ¯”ä¸ºç©ºï¼ˆCSVä¸­ä¸ºç©ºæ ¼æˆ–0ï¼‰ï¼Œè‡ªåŠ¨è®¡ç®— (ä¿ç•™2ä½å°æ•°)
        if (convRate === 0 && regNum > 0 && succNum > 0) {
          convRate = parseFloat(((succNum / regNum) * 100).toFixed(2));
        }
        if (depRateNum === 0 && succNum > 0 && depNum > 0) {
          depRateNum = parseFloat(((depNum / succNum) * 100).toFixed(2));
        }
        if (activeRateNum === 0 && succNum > 0 && activeNum > 0) {
          activeRateNum = parseFloat(((activeNum / succNum) * 100).toFixed(2));
        }

        const record = {
          date: date,
          registrations: regNum,
          successes: succNum,
          conversion_rate: convRate,
          deposits: depNum,
          deposit_rate: depRateNum,
          deposit_assets: parseFloat(depAssets) || 0,
          active_users: activeNum,
          active_rate: activeRateNum,
          revenue: parseFloat(rev) || 0
        };

        importedData.push(record);
      });

      if (errors.length > 0) {
        const showErrors = errors.slice(0, 5).join('\n');
        const more = errors.length > 5 ? `\n...è¿˜æœ‰${errors.length - 5}ä¸ªé”™è¯¯` : '';
        if (!confirm(`âš ï¸ å‘ç°${errors.length}ä¸ªé”™è¯¯:\n${showErrors}${more}\n\næ˜¯å¦ç»§ç»­å¯¼å…¥æœ‰æ•ˆæ•°æ®ï¼Ÿ`)) {
          return;
        }
      }

      if (importedData.length === 0) {
        alert('âŒ æ²¡æœ‰æœ‰æ•ˆæ•°æ®å¯å¯¼å…¥');
        return;
      }

      // è¯¢é—®æ˜¯å¦æ›¿æ¢æˆ–åˆå¹¶
      const action = confirm(
        `ğŸ“Š æˆåŠŸè§£æ${importedData.length}æ¡æ•°æ®\n\nç‚¹å‡»"ç¡®å®š"æ›¿æ¢ç°æœ‰æ•°æ®\nç‚¹å‡»"å–æ¶ˆ"åˆå¹¶åˆ°ç°æœ‰æ•°æ®`
      );

      if (action) {
        // æ›¿æ¢æ¨¡å¼
        rawData = importedData;
      } else {
        // åˆå¹¶æ¨¡å¼ï¼šå»é‡ï¼ˆåŒæ—¥æœŸåˆ™æ›´æ–°ï¼‰
        importedData.forEach(newRecord => {
          const existingIdx = rawData.findIndex(d => d.date === newRecord.date);
          if (existingIdx >= 0) {
            rawData[existingIdx] = newRecord;
          } else {
            rawData.push(newRecord);
          }
        });
      }

      // ä¸æ’åºï¼Œä¿æŒCSVæ–‡ä»¶åŸå§‹é¡ºåº
      localStorage.setItem('weeklyMetrics', JSON.stringify(rawData));
      applyRange();
      
      alert(`âœ… æˆåŠŸå¯¼å…¥${importedData.length}æ¡æ•°æ®ï¼`);
    } catch (error) {
      alert('âŒ CSVè§£æå¤±è´¥: ' + error.message);
    }
  };

  reader.onerror = function() {
    alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥');
  };

  reader.readAsText(file, 'UTF-8');
  
  // é‡ç½®inputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
  event.target.value = '';
}

// åˆå§‹æ¸²æŸ“
applyRange();
</script>

</body>
</html>
